---
title: Chapter 6. Assessment of Sclerotinia sclerotiorum sclerotia recovered from
  soybean and sunflower silos across South African production regions
author: "LAR"
date: "06/06/2020"
output:
  pdf_document:
    toc: yes
  html_document:
    theme: yeti
    toc: yes
    toc_float: yes
---
```{r global_options, echo=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = TRUE)
```

# Introduction 
# Methods & Materials

## Data collection 


## Data analysis & visualisation 


## Analytical Framework


### load libraries 

```{r load libraries}
library(gsheet) #importing data from google drive 
library(tidyverse) #data wrangling and manipulation 
library(ggthemes) #plot customisation
library(rnaturalearth) #shape file
library(ggpubr) #plot customisation
library(psych) #descriptive statistics
```

### data import

```{r data import}
df <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1CQKEHIghYEqX1Qy7aX3F5oc5EvzNA15xtcI8Pd_7r0g/edit#gid=0", "grading") #sclerotia dataframe (df)

reg <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1CQKEHIghYEqX1Qy7aX3F5oc5EvzNA15xtcI8Pd_7r0g/edit#gid=1287063361", "regions") #silo latitude and longitude df

reg = reg %>% 
  rename(region = number) #renaming variable region to number
```

#### tidy data
Creating new qualitative variable to expaling if sclerotia percentage recovered is greater than that of the thresholds set by DAFF and SANSOR. Mutating season variable to account for year, to makes plots beautiful.
```{r  tidy data} 
df %>% 
  rename(season = year) %>% 
  mutate(over_th = case_when(sclerotia_percentage == 0 ~ "No sclerotia detected",
                             sclerotia_percentage > 0 & sclerotia_percentage < 0.2 ~ "Under all thresholds",
                             sclerotia_percentage >= 0.2 & sclerotia_percentage < 4 ~ "Above SANSOR threshold (0.2%)",
                             sclerotia_percentage >=4 ~ "Above DAFF threshold (4%)"),
         year = case_when(season == "2011_2012" ~ "2012",
                          season == "2012_2013" ~ "2013",
                          season == "2013_2014" ~ "2014",
                          season == "2014_2015" ~ "2015",
                          season == "2015_2016" ~ "2016", 
                          season == "2016_2017" ~ "2017",
                          season == "2017_2018" ~ "2018",
                          season == "2018_2019" ~ "2019")) #year = year of harvest
#now we join the sclerotia df with the silo lat and lon df.  
full.df = df %>% 
  full_join(reg)
full.df
```

#### prevalence
We create a df for the prevalence of sclerotia recovered from the production regions
Where prevalnce is defined as the positive events of sclerotia in relation to total sample collected regardless of legislative limitation. 
```{r prevalence df}
prev = df %>% 
  mutate(freq = case_when(sclerotia_percentage > 0 ~ 1, 
                          sclerotia_percentage <= 0 ~ 0)) %>% 
  group_by(crop, year, freq) %>% 
  dplyr::summarise(count = n()) %>% 
  full_join(df %>% 
  mutate(total = case_when(sclerotia_percentage > 0 ~ 1, 
                          sclerotia_percentage <= 0 ~ 0)) %>% 
  group_by(crop, year) %>% 
  dplyr::summarise(total = n()))

prev = prev %>% 
  filter(freq >= 1) %>% 
    mutate(prev = count/total*100) %>% 
  dplyr::select(crop, year, total, prev)

write.csv(prev, "tables/scl_recovery.csv")
```

### one way anova
Compute the analysis of variance for soybean and sunflower
```{r one way anova}
#soybean
res.aov.sb <- aov(sclerotia_percentage ~ year, data = df %>%  
                                               filter(crop =="Soybean"))

summary(res.aov.sb)

#sunflower
res.aov.sf <- aov(sclerotia_percentage ~ year, data = df %>%  
                                  filter(crop =="Sunflower"))
# Summary of the analysis
summary(res.aov.sf)
```

### bar grapns 
Soybean and sunflower mean annual sclerotia recovery percentages are calculated and plotted with their indivual observations, and standard error bars.
```{r bar graphs}
#soybean df
sb.df <- full.df %>% 
  filter(crop == "Soybean")

sf.df <-full.df %>% 
  filter(crop == "Sunflower")

sb <- df %>% 
  group_by(crop, year) %>% 
  dplyr::summarise(mean_per = mean(sclerotia_percentage)) %>% 
  filter(crop == "Soybean")

#sunflower df
sf <- df %>% 
  group_by(crop, year) %>% 
  dplyr::summarise(mean_per = mean(sclerotia_percentage)) %>% 
  filter(crop == "Sunflower")

#soybean plot
ggplot()+
   geom_jitter(data = sb.df, 
              aes(year, sclerotia_percentage), colour = "darkgreen", alpha = 0.6, width = 0.2)+
  geom_col(data = sb.df %>%
              group_by(crop, year) %>%
  dplyr::summarise(mean_per = mean(sclerotia_percentage)),
           aes(year, mean_per), fill = "darkgreen", alpha = 0.2, size = 4)+
   geom_errorbar(width = 0.1, colour = "grey40",
                data = df %>% 
                  filter(crop == "Soybean") %>% 
            group_by(year) %>%
            dplyr::summarise(
              n = n(),
              sd = sd(sclerotia_percentage),
              se = sd/sqrt(n),
              mean_area = mean(sclerotia_percentage),
              lwr_ci = mean_area+ qt(p = 0.025, df = n-1)*se,
              upr_ci = mean_area+ qt(p = 0.975, df = n-1)*se),
            aes(x = year, ymin = lwr_ci, ymax = upr_ci))+
  geom_text(data = df %>% 
              filter(crop == "Soybean") %>% 
              group_by(year) %>% 
              summarise(N = sum(n)),
             aes(year, 0.4, label = N))+
  theme_clean(base_size = 12)+
    labs(
    x = "Year",
    y = "Sclerotia (%) per sample"
  )+
  ggsave("vis/recovery_sb1.png", units = "cm", width = 20, height = 12, dpi = 600)

#sunflower
ggplot()+
   geom_jitter(data = sf.df, 
              aes(year, sclerotia_percentage), colour = "orange", alpha = 0.6, width = 0.2)+
  geom_col(data = sf.df %>%
              group_by(crop, year) %>%
  dplyr::summarise(mean_per = mean(sclerotia_percentage)),
           aes(year, mean_per), fill = "orange", alpha = 0.2, size = 4)+
  geom_text(data = df %>% 
              filter(crop == "Sunflower") %>% 
              group_by(year) %>% 
              summarise(N = sum(n)),
             aes(year, 4, label = N))+
   geom_errorbar(width = 0.1, colour = "grey40",
                data = df %>% 
                  filter(crop == "Sunflower") %>% 
            group_by(year) %>%
            dplyr::summarise(
              n = n(),
              sd = sd(sclerotia_percentage),
              se = sd/sqrt(n),
              mean_area = mean(sclerotia_percentage),
              lwr_ci = mean_area+ qt(p = 0.025, df = n-1)*se,
              upr_ci = mean_area+ qt(p = 0.975, df = n-1)*se),
            aes(x = year, ymin = lwr_ci, ymax = upr_ci))+
  theme_clean(base_size = 12)+
    labs(
    x = "Year",
    y = "Sclerotia (%) per sample"
  )+
  ggsave("vis/recovery_sf1.png", units = "cm", width = 20, height = 12, dpi = 600)
```

### maps 
```{r mapping}
#Shape files are extracted and fortified for use in plotting
south_africa <- ne_states(country = "south africa",
                 returnclass = "sf")
zar_df <- fortify(south_africa)# shape file to dataframe

zar =  zar_df %>% 
  mutate(name = case_when(name == "KwaZulu-Natal" ~ "KwaZulu Natal", 
                          name != "KwaZulu-Natal" ~ name)) %>% 
  dplyr::rename(province = name)#relabeling 

#soybean
ggplot()+
  geom_sf(data = south_africa)+
  geom_jitter(data = full.df %>% 
              filter(crop == "Soybean",
                !is.na(sclerotia_percentage)),
            aes(lon, lat, colour = over_th), alpha = 0.6, size = 2)+
    geom_text(data = full.df %>% 
                filter(crop == "Soybean") %>% 
                group_by(year) %>% 
                summarise(n = n()) %>% 
                mutate(lon = 30, lat = -34),
            aes(lon, lat, label = n), fontface = 3)+
  scale_color_manual(values = c("orange", "blue",  "darkgreen"))+
  ylim(-35, -22.5) +
  xlim(17, 33)+
  labs(x = "Longitude",
       y = "Latitude",
       colour = "Sclerotia thresholds")+
  theme_minimal(base_size = 12)+
  theme(legend.position = "bottom")+
  facet_wrap(~year, ncol = 4)+
  ggsave("vis/prod_reg_sb.png", units = "cm", width = 30, height = 15, dpi = 600)

# sunflower
ggplot()+
  geom_sf(data = south_africa)+
  geom_jitter(data = full.df %>% 
              filter(crop == "Sunflower",
                !is.na(sclerotia_percentage)),
            aes(lon, lat, colour = over_th), alpha = 0.6, size = 2)+
  scale_color_manual(values = c("red", "orange", "blue", "darkgreen"))+
  geom_text(data = full.df %>% 
              filter(crop == "Sunflower") %>% 
              group_by(year) %>% 
              summarise(n = n()) %>% 
              mutate(lon = 30, lat = -34),
            aes(lon, lat, label = n), fontface = 3)+
  ylim(-35, -22.5) +
  xlim(17, 33)+
  labs(x = "Longitude",
       y = "Latitude",
       colour = "Sclerotia thresholds")+
  theme_minimal(base_size = 12)+
  theme(legend.position = "bottom")+
  facet_wrap(~year, ncol = 4)+
  ggsave("vis/prod_reg_sf.png", units = "cm", width = 30, height = 15, dpi = 600)
```

A map of the regions is made for a frame of reference 
```{r region maps}
ggplot()+
  geom_sf(data = south_africa)+
  geom_jitter(data = reg,
            aes(lon, lat), alpha = 0.6, size = 1, width = 0.2, shape = 21)+
    geom_text(data = reg,
            aes(lon, lat, label = region), size = 4 , fontface = 1, colour = "darkblue")+
  ylim(-35, -22.5) +
  xlim(17, 33)+
  labs(x = "Longitude",
       y = "Latitude")+
  theme_minimal(base_size = 16)+
  ggsave("vis/prod_regions.png", units = "cm", width = 20, height = 22, dpi = 600)
```
# Results

# Discussion

# Acknowledgements  

# References 
